generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id           String       @id @default(uuid())
  email        String       @unique
  passwordHash String
  role         UserRole     @default(USER)
  createdAt    DateTime     @default(now())
  permissions  Permission[]
  servers      Server[]
}

model SubUser {
  id           String       @id @default(uuid())
  email        String       @unique
  passwordHash String
  permissions  Permission[]
  createdAt    DateTime     @default(now())
  serverId     String
  server       Server       @relation(fields: [serverId], references: [id])
}

model Node {
  id           String           @id @default(uuid())
  name         String
  endpointUrl  String
  status       NodeStatus       @default(OFFLINE)
  lastSeenAt   DateTime?
  agentVersion String?
  capacityJson Json?
  sharedSecret String
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  allocations  Allocation[]
  enrollments  NodeEnrollment[]
  servers      Server[]
}

model NodeEnrollment {
  id        String    @id @default(uuid())
  tokenHash String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  nodeId    String?
  createdAt DateTime  @default(now())
  node      Node?     @relation(fields: [nodeId], references: [id])
}

model Server {
  id          String      @id @default(uuid())
  name        String
  type        String
  state       ServerState @default(CREATED)
  image       String
  envJson     Json
  limitsJson  Json
  networkJson Json
  storageJson Json
  nodeId      String
  ownerId     String
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  node        Node        @relation(fields: [nodeId], references: [id])
  owner       User        @relation(fields: [ownerId], references: [id])
  subUsers    SubUser[]
}

model Allocation {
  id               String       @id @default(uuid())
  nodeId           String
  ip               String       @default("0.0.0.0")
  port             Int
  protocol         PortProtocol @default(TCP)
  assignedServerId String?      @unique
  createdAt        DateTime     @default(now())
  node             Node         @relation(fields: [nodeId], references: [id])

  @@unique([nodeId, ip, port, protocol])
  @@index([nodeId, assignedServerId])
}

model WsToken {
  id        String   @id @default(uuid())
  tokenHash String   @unique
  serverId  String
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([serverId, userId])
}

enum UserRole {
  ADMIN
  USER
}

enum Permission {
  FILE_READ
  FILE_WRITE
  FILE_DELETE
  FILE_CREATE
  SERVER_CREATE
  SERVER_DELETE
  SERVER_STOP
  SERVER_START
  SERVER_RESTART
  SERVER_READ
  SERVER_UPDATE
  SERVER_CONSOLE_READ
  SERVER_CONSOLE_WRITE
  NODE_CREATE
  NODE_DELETE
  NODE_UPDATE
  NODE_RESTART
  NODE_READ
  USER_CREATE
  USER_DELETE
  USER_UPDATE
  USER_READ
  ALLOCATION_CREATE
  ALLOCATION_DELETE
  ALLOCATION_UPDATE
  ALLOCATION_READ
}

enum NodeStatus {
  ONLINE
  OFFLINE
}

enum ServerState {
  CREATED
  RUNNING
  STOPPED
  ERROR
}

enum PortProtocol {
  TCP
  UDP
}
